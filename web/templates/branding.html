{% extends "base.html" %}
{% block content %}

<style>
  .page-title { font-size:20px; font-weight:950; margin:0 0 6px; }
  .page-sub { color:#64748b; font-size:13px; margin:0 0 16px; line-height:1.45; }

  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; align-items:start; }
  @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }

  .box {
    border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:#fff;
    box-shadow: 0 10px 24px rgba(0,0,0,0.04);
  }

  label { display:grid; gap:6px; margin-top:12px; font-weight:900; color:#111827; }
  input, textarea {
    padding:12px 12px;
    border-radius:14px;
    border:1px solid #d1d5db;
    outline:none;
    width:100%;
    background:#fff;
  }
  textarea { min-height:120px; resize:vertical; }
  input:focus, textarea:focus { border-color:#94a3b8; box-shadow: 0 0 0 3px rgba(148,163,184,0.25); }

  .muted { color:#64748b; font-size:12px; line-height:1.45; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  .btn {
    border:1px solid #d1d5db; background:#fff; padding:10px 12px; border-radius:14px;
    cursor:pointer; text-decoration:none; display:inline-flex; gap:8px; align-items:center;
    font-weight:900;
  }
  .btn-primary { border-color:#111827; background:#111827; color:#fff; }
  .btn-soft { background:#f8fafc; }

  .rule {
    border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#f8fafc;
    display:grid; gap:6px;
  }
  .badge {
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px; font-size:12px; font-weight:950;
    border:1px solid #e5e7eb; background:#fff; color:#0f172a;
    width:max-content;
  }
  .ok { border-color:#86efac; background:#f0fdf4; color:#14532d; }
  .warn { border-color:#fde68a; background:#fffbeb; color:#7c2d12; }
  .danger { border-color:#fca5a5; background:#fef2f2; color:#7f1d1d; }

  .preview {
    border:1px solid #e5e7eb; border-radius:16px; overflow:hidden; background:#fff;
  }
  .pv-top {
    padding:12px 14px; border-bottom:1px solid #e5e7eb; background:#f8fafc;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .pv-body { padding:14px; }
  .logo {
    width:44px; height:44px; border-radius:12px; background:#fff; border:1px solid #e5e7eb;
    object-fit:cover;
  }
  .mini { font-size:12px; color:#64748b; }
  .pv-card {
    border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff;
  }
  .pv-line { margin:0; line-height:1.5; }
</style>

<div>
  <div class="page-title">üé® Branding</div>
  <p class="page-sub">
    These settings are used inside scheduler emails (logo, sender name, support line, footer).  
    Think of this as ‚Äúhow your brand shows up in the client‚Äôs inbox.‚Äù
  </p>
</div>

<div class="grid">
  <!-- LEFT: FORM -->
  <div class="box">
    <div style="font-weight:950; font-size:16px;">Brand details</div>
    <div class="muted" style="margin-top:6px;">
      Save once and you‚Äôre set. Your Scheduler Template can reference these variables.
    </div>

    <form method="POST" id="brandForm" style="margin-top:10px;">
      <label title="Shown in email footer and used as company_name in templates">
        Company name <span class="muted">(required)</span>
      </label>
      <input
        name="company_name"
        id="company_name"
        value="{{ branding.company_name }}"
        placeholder="Your Company Ltd"
        required
      >

      <label title="Used for 'Need help?' line and support_email variable in templates">
        Support email <span class="muted">(recommended)</span>
      </label>
      <input
        name="support_email"
        id="support_email"
        value="{{ branding.support_email }}"
        placeholder="support@yourcompany.com"
      >

      <label title="Must be a direct image URL. Best: PNG/SVG with transparent background.">
        Logo URL <span class="muted">(optional)</span>
      </label>
      <input
        name="logo"
        id="logo"
        value="{{ branding.logo }}"
        placeholder="https://.../logo.png"
      >
      <div class="muted">
        Rule: Use a <b>direct image link</b> (ends with .png/.jpg/.svg). If the link opens a webpage, it may not show.
      </div>

      <label title="Used in the app theme color + emails where applicable">
        Brand color <span class="muted">(hex)</span>
      </label>
      <input
        name="color"
        id="color"
        value="{{ branding.color }}"
        placeholder="#111827"
      >
      <div class="muted">
        Rule: Must be a hex color like <b>#111827</b>. If you type random stuff, the UI can look broken.
      </div>

      <label title="Optional line at the bottom of emails. Plain text recommended.">
        Footer <span class="muted">(optional)</span>
      </label>
      <textarea
        name="footer"
        id="footer"
        placeholder="Short footer shown under the email..."
      >{{ branding.footer }}</textarea>

      <div class="rule" style="margin-top:12px;">
        <div class="badge warn">Rules (don‚Äôt skip)</div>
        <div class="muted">
          <b>1)</b> Footer is plain text. Keep it short (1‚Äì3 lines).<br>
          <b>2)</b> If Footer is empty and Support email exists, we auto-generate: <i>‚ÄúNeed help? Contact support@...‚Äù</i><br>
          <b>3)</b> If both Footer + Support email are empty, your email may look ‚Äúunfinished‚Äù.<br>
          <b>4)</b> If Logo URL is bad, emails still send ‚Äî they just show no logo.
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn btn-primary" type="submit" title="Save branding">
          üíæ Save branding
        </button>
        <a class="btn btn-soft" href="{{ url_for('dashboard') }}" title="Back to dashboard">
          ‚Üê Back
        </a>
        <a class="btn" href="{{ url_for('template_scheduler') }}" title="Edit the HTML template used when personal message is empty">
          üß© Scheduler Template
        </a>
      </div>

      <div class="muted" style="margin-top:10px;">
        Tip: Branding only affects scheduler emails. If you type a Personal message on a follow-up, that content wins.
      </div>
    </form>
  </div>

  <!-- RIGHT: LIVE OUTCOME PREVIEW (plain and safe) -->
  <div class="box">
    <div style="font-weight:950; font-size:16px;">What the client sees</div>
    <div class="muted" style="margin-top:6px;">
      This preview is based on your branding inputs + sample client data.
      It‚Äôs not sending anything.
    </div>

    <div class="preview" style="margin-top:12px;">
      <div class="pv-top">
        <div class="row" style="gap:10px;">
          <img class="logo" id="pvLogo" src="{{ branding.logo }}" alt="Logo" onerror="this.style.display='none'">
          <div>
            <div style="font-weight:950;" id="pvCompany">{{ branding.company_name or "Your Company" }}</div>
            <div class="mini" id="pvSupport">{{ branding.support_email or "support@yourcompany.com" }}</div>
          </div>
        </div>

        <div class="badge ok" id="pvColorBadge">Brand color</div>
      </div>

      <div class="pv-body">
        <div class="pv-card">
          <p class="pv-line"><b>Hi Nelly,</b></p>
          <p class="pv-line" style="margin-top:6px;">Just a quick reminder about <b>proposal</b>.</p>
          <p class="pv-line" style="margin-top:6px;">Please confirm payment timeline.</p>
          <p class="pv-line" style="margin-top:10px;">
            Thanks,<br>
            <span id="pvSender">{{ branding.company_name or "Your Company" }}</span>
          </p>

          <div class="muted" style="margin-top:10px;" id="pvFooter"></div>
        </div>

        <div class="muted" style="margin-top:10px;">
          Heads up: your actual email layout is controlled by the <b>Scheduler Template</b>.
          Branding fills the variables used inside that template.
        </div>
      </div>
    </div>

    <div class="rule" style="margin-top:12px;">
      <div class="badge danger">If preview looks wrong‚Ä¶</div>
      <div class="muted">
        <b>‚Ä¢</b> Logo missing? Your Logo URL isn‚Äôt a direct image link.<br>
        <b>‚Ä¢</b> Support email blank? Add one so clients know where to reply if needed.<br>
        <b>‚Ä¢</b> Footer looks messy? Keep it plain text (no weird HTML).
      </div>
    </div>
  </div>
</div>

<script>
  function isHexColor(v){
    v = (v || "").trim();
    return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v);
  }

  function safeText(v, fallback){
    v = (v || "").trim();
    return v ? v : fallback;
  }

  function refreshBrandPreview(){
    const company = safeText(document.getElementById("company_name")?.value, "Your Company");
    const support = safeText(document.getElementById("support_email")?.value, "support@yourcompany.com");
    const logo = (document.getElementById("logo")?.value || "").trim();
    const footer = (document.getElementById("footer")?.value || "").trim();
    const color = (document.getElementById("color")?.value || "").trim();

    const pvCompany = document.getElementById("pvCompany");
    const pvSupport = document.getElementById("pvSupport");
    const pvSender = document.getElementById("pvSender");
    const pvFooter = document.getElementById("pvFooter");
    const pvLogo = document.getElementById("pvLogo");
    const badge = document.getElementById("pvColorBadge");

    if (pvCompany) pvCompany.textContent = company;
    if (pvSupport) pvSupport.textContent = support;
    if (pvSender) pvSender.textContent = company;

    // footer rules
    if (pvFooter) {
      if (footer) {
        pvFooter.textContent = footer;
      } else if (support) {
        pvFooter.textContent = "Need help? Contact " + support;
      } else {
        pvFooter.textContent = "";
      }
    }

    // logo
    if (pvLogo) {
      if (logo) {
        pvLogo.style.display = "";
        pvLogo.src = logo;
      } else {
        pvLogo.style.display = "none";
      }
    }

    // color badge (visual sanity check)
    if (badge) {
      if (isHexColor(color)) {
        badge.style.borderColor = color;
        badge.style.background = color + "22";
        badge.style.color = "#0f172a";
        badge.textContent = "Brand color " + color;
      } else {
        badge.style.borderColor = "#fde68a";
        badge.style.background = "#fffbeb";
        badge.style.color = "#7c2d12";
        badge.textContent = "Brand color (invalid)";
      }
    }
  }

  ["company_name","support_email","logo","footer","color"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", refreshBrandPreview);
  });

  refreshBrandPreview();
</script>

{% endblock %}
